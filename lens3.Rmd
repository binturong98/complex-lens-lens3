---
title: "Deconstructing a complex Lens - functional implications of key lens protein knockdown in *Thermonectus marmoratus*"
authors: "Mitra AT., Rathore S., Jester A., Hyland-Brown R., Benoit JB., Stowasser A, Tomoyasu Y., Buschbeck EK."
date: "7 April 2024"
output:
  html_document:
    
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    code_fold: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}

# Markdown settings
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 6, fig.width = 8, attr.output='style="max-height: 400px;"') 

# Load packages
library(tidyverse)
library(cowplot)
library(reshape2)
library(grid)
library(gridExtra)
library(plotly)
library(ggpubr)
library(rstatix)
library(ggplotify)
library(Cairo)
```

# Data and subsetting

## Raw data

Raw data files for the ophthalmoscope, edge sharpness and focal length contain one row for **each eye** sampled. For most individuals, there are four rows of data: Right eye 1 & eye 2 and left eye 1 & eye 2. 

Raw data file for behaviour contains data from both the optimal and challenging light arenas.

Not using lens3_hanging_drops.csv as this was the first set of data that were collected. The images are overexposed and positioning isnt' quite right. This makes focal length estimation unreliable.

```{r loading data}

# Load raw data

# Ophthalmoscope
oph_data <- read.csv("lens3_ophthalmoscope.csv", header = TRUE)

# Hanging drops
edge_data <- read.csv("edge_sharpness_long.csv", header = TRUE)

focal_data <- read.csv("back_focal_length.csv", header = TRUE)

# Behaviour
behaviour_data <- read.csv("lens3_behaviour.csv", header = TRUE)

# na.strings converts "NA", "" and " " into na within the body of the file

# Colourblind friendly palette
palette.colors(palette = "Okabe-Ito")
```

```{r unused plots & analyses, include=FALSE}

#Calculating focal length

#Focal length can be estimated in two ways. The first is a calculation of effective focal length (F)-1) F = (image size / object size) * object distance. The effective focal length is an opitcal measurement given as the distance from a principal plane of an optical lens to its imaging plane - Edmund Optics

#The second is a calculation of back focal length (BFL)-2) BFL = (best object image# - best back surface of lens image#) * 5 * 1.33Multiplying by 5 because the images are taken at 5 um increments. 1.33 is the refractive index of water because these lenses view in water and are thus suspended in water for the hanging drop. The back focal length is a mechanical measurement given as the distance between the last surface of an optical lens to its image plane.

#Instead of picking the best focused image manually, back focal length can be estimated from the MATLAB code written by Annette in her current biology bifocal lens paper. This is arguably a more accurate and less biased way of estimating focal length.  

#This is especially because lens3 RNAi causes cataracts which form blurry images which makes it really hard to pick out the best focused image manually. The code also captures that blurriness in the form of low image contrast curves. 
#Calculating difference in size between the first and second images for each eye for each larva. 

#From micrometer slide measured on the 20x objective, 100 um = 151.037 pixels so
#pixel_size <- (100/151.037) = 0.6620894

#Calculating image size in  um
  #hang_data <- hang_data %>% 
  #mutate(image_1_size = (image_1_size_pixels * pixel_size),
         #image_2_size = (image_2_size_pixels * pixel_size)) 
 
#Size of grating in um
  #object_size <- 10000
 
#Distance between grating and lens in um
  #object_distance <- 125000
  
#Focal length in um
#hang_data <- hang_data %>%
  #mutate(focal_length_1 = ((image_1_size/object_size)*object_distance),
         #focal_length_2 = ((image_1_size/object_size)*object_distance))

#Calculating difference in image size
#hang_data <- hang_data %>%
  #mutate(image_size_diff = (image_2_size - image_1_size))


#Visualising differences in focal length between groups. These are per image and per eye.

#LE1 Image 1
#LE1_image1_plot <- hang_data %>%
  #filter(eye == "LE1") %>%
  #ggplot(aes(y= focal_length_1, x = group, fill = group)) +
  #geom_violin(trim = FALSE, alpha = 0.7) +
  #scale_fill_manual(values=c("#009E73", "#E69F00")) +
  #labs(title=NULL,x="Left Eye 1: Image 1", y = "Focal length (um)") +
  #scale_x_discrete(labels = c('Control', "lens3 Injected")) +
  #geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  #geom_jitter(shape = 19, size = 2, alpha = 0.7, position = position_jitter(0.1)) + 
  #theme_classic() +
  #theme(text = element_text(size = rel(4)), legend.position = "none")
  
#LE1_image1_plot

#LE1_image_size_plot <- hang_data %>%
  #filter(eye == "LE1") %>%
  #ggplot(aes(y= image_size_diff, x = group, fill = group)) +
  #geom_violin(trim = FALSE, alpha = 0.7) +
  #scale_fill_manual(values=c("#009E73", "#E69F00")) +
  #labs(title=NULL,x="Left Eye 1", y = "Difference in image size") +
  #scale_x_discrete(labels = c('Control', "lens3 Injected")) +
  #geom_boxplot(width=0.15, fill="white", outlier.alpha = 0)+
  #geom_jitter(shape = 19, size = 2, alpha = 0.7, position = position_jitter(0.1)) + 
  #theme_classic() +
  #theme(text = element_text(size = rel(4)), legend.position = "none")
  
#LE1_image_size_plot

## Right & left combined boxplots - DO NOT USE - see below

#E1: both probes vs controls
#E1_oph <- oph_data %>%
  #filter(eye == "LE1" | eye == "RE1") %>%
  #ggplot(aes(y= bestimagereciprocal, x = probe, fill = probe)) +
  #geom_boxplot(alpha = 0.8) +
  #scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  #labs(title=NULL,x="Eye 1", y = "Object distance (mm)") +
  #scale_x_discrete(labels = c('Control', 'Probe 1', 'Probe 2')) +
  #scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2)) +
  #geom_jitter(shape = 19, size = 2, alpha = 0.7, position = position_jitter(0.1)) + 
  #theme_classic() +
  #theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        #axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        #axis.text = element_text(size = 20, face = "bold"),
                                 #legend.position = "none")

#E1_oph

# Not using these as the analyses don't combine left and right eyes (that becomes pseudo-replication!)
```

# Figures

## Ophthalmoscope

```{r individual eye boxplots}

# LE1
LE1_oph <- oph_data %>%
  filter(eye == "LE1") %>%
  ggplot(aes(y= bestimagereciprocal, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  labs(title=NULL,x="Left Eye 1", y = "Object distance (mm)") +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2),
                     label = c("5", "10", "∞", "10","5")) + # reciprocal for image distance
  geom_jitter(shape = 19, size = 3, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
LE1_oph

# LE2
LE2_oph <- oph_data %>%
  filter(eye == "LE2") %>%
  ggplot(aes(y= bestimagereciprocal, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  labs(title=NULL,x="Left Eye 2", y = "Object distance (mm)") +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2),
                     label = c("5", "10", "∞", "10","5")) +
  geom_jitter(shape = 19, size = 3, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
LE2_oph

# RE1
RE1_oph <- oph_data %>%
  filter(eye == "RE1") %>%
  ggplot(aes(y= bestimagereciprocal, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  labs(title=NULL,x="Right Eye 1", y = "Object distance (mm)") +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2),
                     label = c("5", "10", "∞", "10","5")) +
  geom_jitter(shape = 19, size = 3, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
RE1_oph

# RE2

RE2_oph <- oph_data %>%
  filter(eye == "RE2") %>%
  ggplot(aes(y= bestimagereciprocal, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 17, outlier.size = 2, position = "dodge2") + # Changing outlier shape
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  labs(title=NULL,x="Right Eye 2", y = "Object distance (mm)") +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2),
                     label = c("5", "10", "∞", "10","5")) +
  geom_jitter(shape = 19, size = 3, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
RE2_oph

# Making the individual boxes narrow and putting them next to each other like the osmosis paper figures

# Creating new column with the eye and probe identity to make this easier. Might be a better way to do this?
oph_data <- oph_data %>%
  mutate(eye_probe = paste(eye, probe, sep="_"))

# Reordering factors so control and probe boxes are grouped together
oph_data$eye_probe <- factor(oph_data$eye_probe,
                          c("LE1_control", "RE1_control", "LE2_control", "RE2_control", "LE1_lens3_191", "RE1_lens3_191", "LE2_lens3_191", "RE2_lens3_191", "LE1_lens3_249", "RE1_lens3_249", "LE2_lens3_249", "RE2_lens3_249"))

# Plot for all E1s

E1_LR_oph <- oph_data %>%
  filter(grepl('E1', eye)) %>% #grepl stands for grep logical. It is a funciton that searches for matches or a string or a string vector
  ggplot(aes(y= bestimagereciprocal, x = eye_probe, fill = eye_probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#009E73", "#E69F00",  "#E69F00", "#D55E00", "#D55E00")) +
  labs(title=NULL,x="Eye 1", y = "Object distance (mm)") +
  scale_x_discrete(labels = c('Left', 'Right', 'Left', 'Right', 'Left', 'Right')) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2),
                     label = c("5", "10", "∞", "10","5")) +
  geom_jitter(shape = 19, size = 3, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
E1_LR_oph 

# Trying custom facet grid labels and using the labeller function
probe.labs <- c("control" = "Control","lens3_191" = "lens3RNAi P1", "lens3_249" = "lens3RNAi P2")

# Trying to make multilevel x-axes

E1_LR_oph <- E1_LR_oph + facet_grid(~ probe, scales = "free", labeller = labeller(probe = probe.labs)) 

# Changing text size of facet grid labels
E1_LR_oph <- E1_LR_oph + theme(strip.text.x = element_text(size = 20, face = "bold"))

# Customising facet appearance
E1_LR_oph <- E1_LR_oph + theme(strip.background = element_rect(size = 1.5, linetype = "solid"))

E1_LR_oph

# Adding colours to facet labels

# First removing the y axis label because I cannot for the life of me figure out why this isn't straightforward to do with theme() after converting the grob back to a ggplot object.

E1_LR_oph_fig <- E1_LR_oph + theme(axis.title.y = element_blank())

E1_g <- ggplot_gtable(ggplot_build(E1_LR_oph_fig)) # converting the ggplot list to a grob and modifying it
strip_t <- which(grepl('strip-', E1_g$layout$name))
fills <- c("#009E73","#E69F00","#D55E00")
k <- 1
for (i in strip_t) {
j <- which(grepl('rect', E1_g$grobs[[i]]$grobs[[1]]$childrenOrder))
E1_g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
k <- k+1
}
grid.draw(E1_g)

# Converting the grob to a ggplot object to align plots with cowplot
E1_LR_oph_fig <- as.ggplot(E1_g) 

# Plot for all E2s

E2_LR_oph <- oph_data %>%
  filter(grepl('E2', eye)) %>% #grepl stands for grep logical. It is a funciton that searches for matches or a string or a string vector
  ggplot(aes(y= bestimagereciprocal, x = eye_probe, fill = eye_probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#009E73", "#E69F00", "#E69F00", "#D55E00", "#D55E00")) +
  labs(title=NULL,x="Eye 2", y = "Object distance (mm)") +
  scale_x_discrete(labels = c('Left', 'Right', 'Left', 'Right', 'Left', 'Right')) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2),
                     label = c("5", "10", "∞", "10","5")) +
  geom_jitter(shape = 19, size = 3, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
E2_LR_oph 

# Trying to make multilevel x-axes
E2_LR_oph <- E2_LR_oph + facet_grid(~ probe, scales = "free", labeller = labeller(probe = probe.labs)) 

# Changing text size of facet grid labels
E2_LR_oph <- E2_LR_oph + theme(strip.text.x = element_text(size = 20, face = "bold"))

# Customising facet appearance
E2_LR_oph <- E2_LR_oph + theme(strip.background = element_rect(size = 1.5, linetype = "solid"))

E2_LR_oph

```

```{r ophthalmoscope figure}
# Make panels 
fig.a <- E1_LR_oph +
theme(legend.position = "none")

fig.a

fig.b <- E2_LR_oph +
theme(legend.position = "none") +
  labs(y = NULL) + #removes y axis label
  guides(y = "none") #removes y axis line and numbers

fig.b

# Use cowplot package to nicely plot the graphs together with a shared common legend.
wide_plot <- plot_grid(fig.a, NULL, fig.b, 
                   #list of plots to arrange in grid
                   rel_widths = c(6, 0.2, 6),
                   align = "h",
                   nrow = 1)

plot_grid(wide_plot)

# Print graph
cairo_pdf(file = "Figures/ophthalmoscope_wide.pdf", width = 12,  height = 6) # cairo_pdf is able to handle special characters
wide_plot
dev.off()

# Stacking the plots on top of each other instead of putting them side to side
fig.a <- E1_LR_oph_fig +
theme(legend.position = "none",
      axis.title.y = element_blank(),
      axis.text.y = element_blank()) +
  labs(y = NULL)

fig.a

fig.b <- E2_LR_oph +
theme(legend.position = "none",
      strip.text.x = element_blank())+ #removing facet_grid second x axis label
  labs(y = NULL)

fig.b

# Combining plots

long_plot <- plot_grid(fig.a, fig.b, align = 'v', axis = 'r',
                       nrow = 2)
plot_grid(long_plot)

# Creating common y axis label
y.grob <- textGrob("Object distance (mm)", 
                   gp = gpar(fontface = "bold",
                             fontsize = 30), rot = 90)

# Print graph
cairo_pdf(file = "Figures/ophthalmoscope_long.pdf", width = 12,  height = 9) # cairo_pdf is able to handle special characters
grid.arrange(arrangeGrob(long_plot, left = y.grob)) #adding common y axis label to plot
dev.off()
```

## Relative Edge Sharpness 

Comparing the relative edge sharpness curves across groups using LOESS, which is a locally weighted scatterplot smoother. The method fits a smooth line through data by fitting weighted least squares (WLS) models to observations within a user-specified window of the focal point, whose width (span) is typically expressed as a proportion α of the n data points. The ribbon is representative of standard error.  

```{r relative edge sharpness plots}

# Creating new column with the eye and probe identity
edge_data <- edge_data %>%
  mutate(eye_probe = paste(eye, probe, sep="_"))

# Trimming dataset to 550 µm for consistency
edge_data <- edge_data %>%
  filter(distance <= 600)

# Individual eye plots

# LE1
LE1_edge_plot <- edge_data %>%
  filter(eye == "LE1") %>%
  ggplot(aes(y= contrast, x = distance, group = eye_probe)) +
  #geom_point() +
  stat_smooth(span = 0.1, se = TRUE,
              method = 'loess',
              formula = 'y ~ x',
              aes(fill = eye_probe, colour = eye_probe)) +
  scale_colour_manual(values = c("#009E73", "#E69F00", "#D55E00"), labels = c("Control", "lens3RNAi P1", "lens3RNAi P2")) +
  scale_fill_manual(values = c("#009E73", "#E69F00", "#D55E00"), labels = c("Control", "lens3RNAi P1", "lens3RNAi P2")) + # For some reason, if labels are not specified in both colour and fill, they are plotted twice. Weird
  scale_x_continuous("Distance from back surface of lens (µm)", 
                     breaks = c(250, 350, 450, 550), 
                     limits = c(185, 600)) +
  scale_y_continuous("Relative edge sharpness",
                     breaks = c(1, 1.5, 2.5, 3.5)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -1.2),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = 15))
LE1_edge_plot 

# LE2
LE2_edge_plot <- edge_data %>%
  filter(eye == "LE2") %>%
  ggplot(aes(y= contrast, x = distance, group = eye_probe)) +
  #geom_point() +
  stat_smooth(span = 0.1, se = TRUE,
              method = 'loess',
              formula = 'y ~ x',
              aes(fill = eye_probe, colour = eye_probe))+
  scale_colour_manual(values = c("#009E73", "#E69F00", "#D55E00"), labels = c("Control", "lens3RNAi P1", "lens3RNAi P2")) +
  scale_fill_manual(values = c("#009E73", "#E69F00", "#D55E00"), labels = c("Control", "lens3RNAi P1", "lens3RNAi P2")) + # For some reason, if labels are not specified in both colour and fill, they are plotted twice. Weird
  scale_x_continuous("Distance from back surface of lens (µm)", 
                     breaks = c(250, 350, 450, 550), 
                     limits = c(185, 600)) +
  scale_y_continuous("Relative edge sharpness",
                     breaks = c(1, 2, 3, 4)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -1.2),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 25, face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = 15))
LE2_edge_plot 

# RE1
RE1_edge_plot <- edge_data %>%
  filter(eye == "RE1") %>%
  ggplot(aes(y= contrast, x = distance, group = eye_probe)) +
  #geom_point() +
  stat_smooth(span = 0.1, se = TRUE, 
              method = 'loess',
              formula = 'y ~ x',
              aes(fill = eye_probe, colour = eye_probe)) +
  scale_colour_manual(values = c("#009E73", "#E69F00", "#D55E00"), labels = c("Control", "lens3RNAi P1", "lens3RNAi P2")) +
  scale_fill_manual(values = c("#009E73", "#E69F00", "#D55E00"), labels = c("Control", "lens3RNAi P1", "lens3RNAi P2")) + # For some reason, if labels are not specified in both colour and fill, they are plotted twice. Weird
  scale_x_continuous("Distance from back surface of lens (µm)", 
                     breaks = c(250, 350, 450, 550), 
                     limits = c(185, 600)) +
  scale_y_continuous("Relative edge sharpness",
                     breaks = c(1, 1.5, 2.5, 3.5)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -1.2),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = 15))
RE1_edge_plot 

# RE2
RE2_edge_plot <- edge_data %>%
  filter(eye == "RE2") %>%
  ggplot(aes(y= contrast, x = distance, group = eye_probe, colour = eye_probe)) +
  #geom_point() +
  stat_smooth(span = 0.1, se = TRUE,
              method = 'loess',
              formula = 'y ~ x',
              aes(fill = eye_probe, colour = eye_probe)) + 
  scale_colour_manual(values = c("#009E73", "#E69F00", "#D55E00")) +
  scale_fill_manual(values = c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_continuous("Distance from back surface of lens (µm)", 
                     breaks = c(250, 350, 450, 550), 
                     limits = c(185, 600)) +
  scale_y_continuous("Relative edge sharpness",
                     breaks = c(1, 2, 3, 4)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -1.2),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
        legend.position = "none")
RE2_edge_plot 

# individual plots
individual_edge_plot <- edge_data %>%
  filter(individual == "249_18") %>%
  ggplot(aes(y= contrast, x = distance, group = eye)) +
  geom_point(aes(fill = eye_probe, colour = eye_probe)) +
  scale_colour_manual(values = c("#56B4E9", "#E69F00", "#0072B2", "#D55E00")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#0072B2", "#D55E00")) + # For some reason, if labels are not specified in both colour and fill, they are plotted twice. Weird
  scale_x_continuous("Distance from back surface of lens (µm)") +
  scale_y_continuous("Relative edge sharpness") +
  theme_classic() +
  theme(axis.title.x = element_text(size = 15, face = "bold", vjust = -1.2),
        axis.title.y = element_text(size = 15, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 15, face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = 15))
individual_edge_plot 

# Unused but useful bit of code
# Melting the data by distance to make it long format edge_data <- melt(edge_data, id.vars = "distance", value.name = "contrast")

# Pulling information from rows and trying to organise it into a new column: edge_data_long$left <- str_detect(edge_data_long$variable, "L") 
```

```{r edge sharpness figure}

pdf(file = "Figures/LE2_edge_sharpness.pdf", width = 9,  height = 6)
LE2_edge_plot
dev.off()

```

Comparing maximum edge sharpness values between controls and tests. This usually corresponds to the second peak/image. However, sometimes the first peak has higher edge sharpness in the knockdowns; That's some of the eyes of 3/10 individuals for Probe 1 and 4/10 individuals for Probe 2. In some eyes of 2/10 Probe 2 individuals, best focused images could not be detected in the edge sharpness plots or manually

```{r maximum edge sharpness boxplots}

# LE1
LE1_max_edge <- focal_data %>%
  filter(eye == "LE1") %>%
  ggplot(aes(y= maximum_sharpness, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Left eye 1", y = "Maximum edge sharpness") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
LE1_max_edge

# LE2
LE2_max_edge <- focal_data %>%
  filter(eye == "LE2") %>%
  ggplot(aes(y= maximum_sharpness, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Left eye 2", y = "Maximum edge sharpness") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
LE2_max_edge

# RE1
LE2_max_edge <- focal_data %>%
  filter(eye == "RE1") %>%
  ggplot(aes(y= maximum_sharpness, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Right eye 1", y = "Maximum edge sharpness") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
LE2_max_edge

# RE2
RE2_max_edge <- focal_data %>%
  filter(eye == "RE2") %>%
  ggplot(aes(y= maximum_sharpness, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Right eye 2", y = "Maximum edge sharpness") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
RE2_max_edge

# scale_x_discrete(labels = c('Control', 'Probe 1', 'Probe 2')) +
# scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2)) +
```

## Back focal length
Only using the 2nd (typically taller) peak for this because the 1st is often hard to detect. Went through the image series side-by-side to verify these. 
```{r back focal length boxplots}

# LE1
LE1_focal <- focal_data %>%
  filter(eye == "LE1") %>%
  ggplot(aes(y= peak_2_um, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Left eye 1", y = "Back focal length (µm)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
LE1_focal

# LE2
LE2_focal <- focal_data %>%
  filter(eye == "LE2") %>%
  ggplot(aes(y= peak_2_um, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Left eye 2", y = "Back focal length (µm)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 25, face = "bold"),
                                 legend.position = "none")
LE2_focal

# RE1
RE1_focal <- focal_data %>%
  filter(eye == "RE1") %>%
  ggplot(aes(y= peak_2_um, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Right eye 1", y = "Back focal length") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
RE1_focal

# RE2
RE2_focal <- focal_data %>%
  filter(eye == "RE2") %>%
  ggplot(aes(y= peak_2_um, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x="Right eye 2", y = "Back focal length") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
RE2_focal

# scale_x_discrete(labels = c('Control', 'Probe 1', 'Probe 2')) +
# scale_y_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2)) +
```

```{r back focal length figure}

pdf(file = "Figures/LE2_back_focal.pdf", width = 8.5,  height = 8.5)
LE2_focal
dev.off()

```

## Behaviour
```{r calculating total strikes & hunting success}

# Creating total strike and percentage hunting success columns
behaviour_data <- behaviour_data %>%
  mutate(total_strikes = missed_strikes + succesful_strikes) %>%
  mutate(missed_dead_prey_strikes_NA_removed = missed_dead_prey_strikes) %>% # duplicating the missed dead prey strikes column because NAs need to be turned to 0s to properly calculate % hunting success. 
  replace_na(list(missed_dead_prey_strikes_NA_removed = 0)) %>%
  mutate(hunting_success = (succesful_strikes - (dead_prey_strikes - missed_dead_prey_strikes_NA_removed))/3 * 100)

# Creating a column with Probe 1 and Probe 2 pooled into a single lens3 category
behaviour_data <- behaviour_data %>%
  mutate(group = probe) %>% # making a duplicate probe column called group
  mutate(group = replace(group, probe == 'lens3_191' | probe == 'lens3_249', 'lens3')) # using probe as a reference, replacing 'lens3_191' and 'lens3_249 with 'lens3'
```


## Normal light conditions

### Missed strikes 
Normal light
```{r normal light missed strikes}

## horizontal arena
missed_strikes_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y= missed_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Missed Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
missed_strikes_horizontal

## vertical arena
missed_strikes_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y= missed_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Missed Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
missed_strikes_vertical
```

### Succesful strikes 
Normal light
```{r normal light succesful strikes}

## horizontal arena
succesful_strikes_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y= succesful_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Succesful Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
missed_strikes_horizontal

## vertical arena
succesful_strikes_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y= succesful_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Succesful Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
succesful_strikes_vertical
```

### Hunting success
Normal light
```{r normal light hunting success}

### separate probes

## horizontal arena
hunting_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y = hunting_success, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center', # using geom_dotplot here instead of geom_jitter so that the points are stacked horizontally and centre aligned (stackdir). Important as there are only 3 values for hunting success and geom_jitter makes it seem like there are more.
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) + #stackratio adjusts distance between points 
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 30, face = "bold"),
        legend.position = "none")
hunting_horizontal

## vertical arena
hunting_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y = hunting_success, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 30, face = "bold"),
        legend.position = "none")
hunting_vertical

### pooled probes

## horizontal arena
hunting_horizontal_pooled <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y = hunting_success, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
   scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  #scale_x_discrete(labels = c(expression("control" = Control, "lens3" = italic(lens3)~RNAi))) + ## tried to write this piece of code to selectively italicise lens3 but for some reason it doesn't italicise numbers and also creates a space between lens3 and RNAi. 
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
        legend.position = "none")
hunting_horizontal_pooled

## vertical
hunting_vertical_pooled <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y = hunting_success, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
        legend.position = "none")
hunting_vertical_pooled
```

### Total strikes 
Normal light
```{r normal light total strikes}

# horizontal arena
total_strikes_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y= total_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Total Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
total_strikes_horizontal

## vertical arena
total_strikes_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y= total_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Total Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
total_strikes_vertical
```

### Latency 
Normal light
```{r normal light latency}

### separate probes

## horizontal arena
latency_horizontal_separate <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y= latency_min, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 30, face = "bold"),
                                 legend.position = "none")
latency_horizontal_separate

## vertical arena
latency_vertical_separate <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y= latency_min, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 25, face = "bold"),
                                 legend.position = "none")
latency_vertical_separate

### pooled probes

## horizontal arena
latency_horizontal_pooled <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "horizontal" & light_environment == "normal") %>%
  ggplot(aes(y= latency_min, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  #geom_signif(comparisons=list(c("control", "lens3")), annotations="ns", # adds a significance bar
              #map_signif_level = TRUE, textsize = 5, vjust = -0.1) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
         axis.text.y = element_text(size = 30, face = "bold"),
         axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
                                 legend.position = "none")
latency_horizontal_pooled

## vertical arena
latency_vertical_pooled <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "vertical" & light_environment == "normal") %>%
  ggplot(aes(y= latency_min, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  #geom_signif(comparisons=list(c("control", "lens3")), annotations="ns", 
              #map_signif_level = TRUE, textsize = 5, vjust = -0.1) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
         axis.text.y = element_text(size = 30, face = "bold"),
         axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
                                 legend.position = "none")
latency_vertical_pooled
```

## Dark conditions
96% LEDs covered and UV supplementation removed

### Missed strikes
Dark
```{r dark missed strikes}

## horizontal arena
dark_missed_strikes_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y= missed_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Missed Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
dark_missed_strikes_horizontal

## vertical arena
dark_missed_strikes_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y= missed_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Missed Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
dark_missed_strikes_vertical
```

### Succesful strikes
Dark
```{r dark succesful strikes}

## horizontal arena
dark_succesful_strikes_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y= succesful_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Succesful Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
dark_succesful_strikes_horizontal

## vertical arena
dark_succesful_strikes_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y= succesful_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Succesful Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
dark_succesful_strikes_vertical
```

### Hunting success
Dark
```{r dark hunting success}

### separate probes

## horizontal arena
dark_hunting_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y = hunting_success, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 30, face = "bold"),
        legend.position = "none")
dark_hunting_horizontal

## vertical
dark_hunting_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y = hunting_success, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 30, face = "bold"),
        legend.position = "none")
dark_hunting_vertical

### pooled probes

## horizontal arena
dark_hunting_horizontal_pooled <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y = hunting_success, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
   scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.5, position = position_dodge(0.8)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
         axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
        legend.position = "none")
dark_hunting_horizontal_pooled

## vertical
dark_hunting_vertical_pooled <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y = hunting_success, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA, position = position_dodge(0.8)) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  labs(title=NULL,x= "", y = "% Hunting success") +
  geom_dotplot(aes(fill = NULL, alpha = 0.1), binaxis = 'y', stackdir = 'center',
        stackratio = 1.5, dotsize = 1.4, position = position_dodge(0.8)) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
         axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
        legend.position = "none")
dark_hunting_vertical_pooled
```

### Total strikes
Dark
```{r dark total strikes}

# horizontal arena
dark_total_strikes_horizontal <- behaviour_data %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y= total_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Total Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
dark_total_strikes_horizontal

# vertical arena
dark_total_strikes_vertical <- behaviour_data %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y= total_strikes, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  labs(title=NULL,x= "", y = "Total Strikes") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 25, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 25, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 20, face = "bold"),
                                 legend.position = "none")
dark_total_strikes_vertical
```

### Latency
Dark
```{r dark latency}

### separate probes

## horizontal arena
dark_latency_horizontal_separate <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y= latency_min, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 30, face = "bold"),
                                 legend.position = "none")
dark_latency_horizontal_separate

## vertical arena
dark_latency_vertical_separate <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y= latency_min, x = probe, fill = probe)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#E69F00", "#D55E00")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi P1', 'lens3RNAi P2')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  theme_classic() +
  theme(axis.title.x = element_text(size = 30, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 30, face = "bold", vjust = 1.8),
        axis.text = element_text(size = 25, face = "bold"),
                                 legend.position = "none")
dark_latency_vertical_separate

### pooled probes

## horizontal arena
dark_latency_horizontal_pooled <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "horizontal" & light_environment == "dark") %>%
  ggplot(aes(y= latency_min, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  geom_signif(comparisons=list(c("control", "lens3")), annotations="*", # adds a significance star
              map_signif_level = TRUE, textsize = 10, 
              vjust = 0.5,
              margin_top = 0.35) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
         axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
                                 legend.position = "none")
dark_latency_horizontal_pooled

## vertical arena
dark_latency_vertical_pooled <- behaviour_data %>%
  drop_na(latency_min) %>%
  filter(arena == "vertical" & light_environment == "dark") %>%
  ggplot(aes(y= latency_min, x = group, fill = group)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  scale_fill_manual(values=c("#009E73", "#CC79A7")) +
  scale_x_discrete(labels = c('Control', 'lens3RNAi')) +
  scale_y_continuous(limits = c(0, 26), breaks = c(0, 5, 10, 15, 20, 25)) +
  labs(title=NULL,x= "", y = "Latency (min)") +
  geom_jitter(shape = 19, size = 3.5, alpha = 0.7, position = position_jitter(0.1)) + 
  geom_signif(comparisons=list(c("control", "lens3")), annotations="*", # adds a significance star
              map_signif_level = TRUE, textsize = 10, 
              vjust = 0.5,
              margin_top = 0.35) +
  theme_classic() +
  theme(axis.title.x = element_text(size = 40, face = "bold", vjust = -0.15),
        axis.title.y = element_text(size = 40, face = "bold", vjust = 1.8),
         axis.text.y = element_text(size = 30, face = "bold"),
        axis.text.x = element_text(size = 30),
                                 legend.position = "none")
dark_latency_vertical_pooled
```

```{r behaviour figure}

#make latency panels 
fig.a <- latency_horizontal_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off") 

fig.a

fig.b <- latency_vertical_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")

fig.b

fig.c <- dark_latency_horizontal_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off") 

fig.c

fig.d <- dark_latency_vertical_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")

fig.d

# use cowplot package to nicely plot the graphs together with a shared common legend.
latency_plot <- plot_grid(fig.a, fig.c, fig.b, fig.d, 
                   #list of plots to arrange in grid
                   rel_widths = c(6, 6, 6, 6),
                   axis = c("b", "b", "b", "b"),
                   ncol = 2,
                   vjust = 1)

plot_grid(latency_plot)

y.grob.latency <- textGrob("Latency (min)",
                   just = "left", hjust = 0.4, vjust = 0.4,
                   gp = gpar(fontface = "bold",
                             fontsize = 30), rot = 90)

latency_plot_axis <- grid.arrange(arrangeGrob(latency_plot, left = y.grob.latency)) #adding common y axis


#make hunting success panels 
fig.e <- hunting_horizontal_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off") 

fig.e

fig.f <- hunting_vertical_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")

fig.f

fig.g <- dark_hunting_horizontal_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off") 

fig.g

fig.h <- dark_hunting_vertical_pooled +
  labs(y = NULL) +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")

fig.h

# use cowplot package to nicely plot the graphs together with a shared common legend.
hunting_plot <- plot_grid(fig.e, fig.f, fig.g, fig.h, 
                   #list of plots to arrange in grid
                   rel_widths = c(6, 6, 6, 6),
                   axis = c("b", "b", "b", "b"),
                   ncol = 2,
                   vjust = 1) 

plot_grid(hunting_plot)

y.grob.hunting <- textGrob("% Hunting success",
                   just = "left", hjust = 0.4, vjust = 0.4,
                   gp = gpar(fontface = "bold",
                             fontsize = 30), rot = 90)

hunting_plot_axis <- grid.arrange(arrangeGrob(hunting_plot, left = y.grob.hunting)) #adding common y axis

behaviour_figure <- grid.arrange(arrangeGrob(latency_plot_axis, hunting_plot_axis, nrow = 2))

#print graph
pdf(file = "Figures/behaviour.pdf", width = 15,  height = 16)
grid.arrange(arrangeGrob(latency_plot_axis, hunting_plot_axis,
                         nrow = 2)) #stacking the latency and hunting success plots on top of each other
dev.off()

```

# Statistics

## Ophthalmoscope
```{r ophthalmoscope stats}

## Test for normality

# Building the linear model
oph_model <- lm(bestimagereciprocal ~ probe, data = oph_data)

# Creating a QQ plot of residuals
ggqqplot(residuals(oph_model))

# Test for normality
shapiro_test(residuals(oph_model))
# p < 0.05 so can't assume normality

# Checking normality assumption by groups
oph_data %>%
  group_by(probe) %>%
  shapiro_test(bestimagereciprocal)
# again p < 0.05 so can't assume normality

# Creating QQ plots for each group level
ggqqplot(oph_data, "bestimagereciprocal", facet.by = "probe")
# Probe 2 (lens3_249) is the only one that looks normal. Other two are kinda wonky

# Using a Kruskal-Wallis test
res_oph_kw <- compare_means(bestimagereciprocal ~ probe, data = oph_data, 
              group.by = "eye", method = 'kruskal.test')
res_oph_kw

summary(res_oph_kw)
# No significant changes in focused state with lens3 knockdown - all eyes

```

## Edge sharpness series
```{r edge sharpness stats}

## Test for normality

# Building the linear model
edge_model <- lm(maximum_sharpness ~ probe, data = focal_data)

# Creating a QQ plot of residuals
ggqqplot(residuals(edge_model))

# Test for normality
shapiro_test(residuals(edge_model))
# p < 0.05 so not assuming normality

# Checking normality assumption by groups
focal_data %>%
  group_by(probe) %>%
  shapiro_test(maximum_sharpness)
# again p < 0.05 so not assuming normality

# Creating QQ plots for each group level
ggqqplot(focal_data, "maximum_sharpness", facet.by = "probe")
# Control and Probe 1 look normal. Probe 2 is kinda wonky. But will proceed with Gaussian stats

# Using an ANOVA test
res_edge_kw <- compare_means(maximum_sharpness ~ probe, data = focal_data, 
              group.by = "eye", method = 'kruskal.test')
res_edge_kw

summary(res_edge_kw)
# Significant changes in maximum edge sharpness with lens3 knockdown - all eyes

```

## Back focal length
```{r back focal length stats}

## Test for normality

# Building the linear model
focal_model <- lm(peak_2_um ~ probe, data = focal_data)

# Creating a QQ plot of residuals
ggqqplot(residuals(focal_model))

# Test for normality
shapiro_test(residuals(focal_model))
# p > 0.05 so assuming normality

# Checking normality assumption by groups
focal_data %>%
  group_by(probe) %>%
  shapiro_test(peak_2_um)
# again p > 0.05 so assuming normality

# Creating QQ plots for each group level
ggqqplot(focal_data, "peak_2_um", facet.by = "probe")
# Control and Probe 1 look normal. Probe 2 is kinda wonky. But will proceed with Gaussian stats

# Using an ANOVA test
res_focal_aov <- compare_means(peak_2_um ~ probe, data = focal_data, 
              group.by = "eye", method = 'anova')
res_focal_aov

summary(res_focal_aov)
# No significant changes in back focal length with lens3 knockdown - all eyes

```

## Behaviour

## Normal light conditions
### Latency separate probes
```{r normal light latency separate probes}

## Test for normality 

# Building the linear model
latency_model_hor_light <- lm(latency_min ~ probe, data = behaviour_data, subset = (light_environment == 'normal' & arena == 'horizontal'))

# Creating a QQ plot of residuals
ggqqplot(residuals(latency_model_hor_light))

# Test for normality
shapiro_test(residuals(latency_model_hor_light))
# p < 0.05 so can't assume normality

# Checking normality assumption by groups
behaviour_data %>%
  filter(light_environment == 'normal' & arena == 'horizontal') %>%
  group_by(probe) %>%
  shapiro_test(latency_min)
# controls aren't normal but the other two are?

# Creating QQ plots for each group level

# Using an ANOVA test
res_latency_light_hor_kw <- compare_means(latency_min ~ probe, data = behaviour_data, 
                                          subset = (light_environment == 'normal'), 
                                          group.by = "arena", method = 'kruskal.test')
res_latency_light_hor_kw

# No significant changes in back focal length with lens3 knockdown - all eyes
```

## Dark conditions
### Latency separate probes
```{r dark behaviour latency stats separate probes}

## Horizontal
# Building the linear model
latency_model_hor_dark <- lm(latency_min ~ probe, data = behaviour_data, subset = (light_environment == 'dark' & arena == 'horizontal'))

# Creating a QQ plot of residuals
ggqqplot(residuals(latency_model_hor_dark))

# Test for normality
shapiro_test(residuals(latency_model_hor_dark))
# p > 0.05 so can assume normality

# Checking normality assumption by groups
behaviour_data %>%
  filter(light_environment == 'dark' & arena == 'horizontal') %>%
  group_by(probe) %>%
  shapiro_test(latency_min)
# Controls not normal but other probes 1 and 2 are?

## Vertical
# Building the linear model
latency_model_ver_dark <- lm(latency_min ~ probe, data = behaviour_data, subset = (light_environment == 'dark' & arena == 'vertical'))

# Creating a QQ plot of residuals
ggqqplot(residuals(latency_model_ver_dark))

# Test for normality
shapiro_test(residuals(latency_model_ver_dark))
# p > 0.05 so can assume normality

# Checking normality assumption by groups
behaviour_data %>%
  filter(light_environment == 'dark' & arena == 'vertical') %>%
  group_by(probe) %>%
  shapiro_test(latency_min)
# All normal

# Checking for homogeneity of variance across groups with Levene's test
var_latency_dark <- behaviour_data %>%
  filter(light_environment == 'dark') %>%
  group_by(arena) %>%
  levene_test(latency_min ~ probe)

var_latency_dark
# Variances are not significantly different across groups

# Using an ANOVA test
res_latency_dark <- compare_means(latency_min ~ probe, data = behaviour_data, 
                                          subset = (light_environment == 'dark'), 
                                          group.by = "arena", method = 'anova')
res_latency_dark

# Using a different ANOVA function
res_latency_dark_horizontal <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'horizontal') %>%
  anova_test(latency_min ~ probe)

res_latency_dark_horizontal

res_latency_dark_vertical <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'vertical') %>%
  anova_test(latency_min ~ probe)

res_latency_dark_vertical
# not significant
```

### Latency pooled probes
```{r dark behaviour latency stats pooled probes}

## Horizontal
# Building the linear model
pooled_latency_model_hor_dark <- lm(latency_min ~ group, 
                                    data = behaviour_data, 
                                    subset = (light_environment == 'dark' & arena == 'horizontal'))

# Creating a QQ plot of residuals
ggqqplot(residuals(pooled_latency_model_hor_dark))

# Test for normality
shapiro_test(residuals(pooled_latency_model_hor_dark))
# p < 0.05 so can't assume normality

# Checking normality assumption by groups
behaviour_data %>%
  filter(light_environment == 'dark' & arena == 'horizontal') %>%
  group_by(group) %>%
  shapiro_test(latency_min)
# controls normal but lens3 not

## Vertical
# Building the linear model
pooled_latency_model_ver_dark <- lm(latency_min ~ group, 
                                    data = behaviour_data, 
                                    subset = (light_environment == 'dark' & arena == 'vertical'))

# Creating a QQ plot of residuals
ggqqplot(residuals(pooled_latency_model_ver_dark))

# Test for normality
shapiro_test(residuals(pooled_latency_model_ver_dark))
# p > 0.05 so *can* assume normality

# Checking normality assumption by groups
behaviour_data %>%
  filter(light_environment == 'dark' & arena == 'vertical') %>%
  group_by(group) %>%
  shapiro_test(latency_min)
# not normal

## non-parametric
# horizontal test
res_latency_dark_horizontal_pooled_wil <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'horizontal') %>%
  wilcox_test(latency_min ~ group)

res_latency_dark_horizontal_pooled_wil
# significant!!

# vertical test
res_latency_dark_vertical_pooled_wil <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'vertical') %>%
  wilcox_test(latency_min ~ group)

res_latency_dark_vertical_pooled_wil
# significant!!

## parametric
# horizontal test
res_latency_dark_horizontal_pooled_t <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'horizontal') %>%
  t_test(latency_min ~ group)

res_latency_dark_horizontal_pooled_t
# significant!!

# vertical test
res_latency_dark_vertical_pooled_t <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'vertical') %>%
  t_test(latency_min ~ group)

res_latency_dark_vertical_pooled_t
# significant!!
```

### Hunting success pooled probes
```{r dark behaviour latency stats pooled probes}

## Horizontal
# Building the linear model
pooled_hunting_model_hor_dark <- lm(hunting_success ~ group, 
                                    data = behaviour_data, 
                                    subset = (light_environment == 'dark' & arena == 'horizontal'))

# Creating a QQ plot of residuals
ggqqplot(residuals(pooled_hunting_model_hor_dark))

# Test for normality
shapiro_test(residuals(pooled_hunting_model_hor_dark))
# p < 0.05 so can't assume normality - as expected 


## Vertical
# Building the linear model
pooled_hunting_model_ver_dark <- lm(hunting_success ~ group, 
                                    data = behaviour_data, 
                                    subset = (light_environment == 'dark' & arena == 'vertical'))

# Creating a QQ plot of residuals
ggqqplot(residuals(pooled_hunting_model_ver_dark))

# Test for normality
shapiro_test(residuals(pooled_hunting_model_ver_dark))
# p > 0.05 so can't assume normality - as expected 

# horizontal test
res_hunting_dark_horizontal_pooled_wil <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'horizontal') %>%
  wilcox_test(hunting_success ~ group)

res_hunting_dark_horizontal_pooled_wil
# not significant

# vertical test
res_hunting_dark_vertical_pooled_wil <- behaviour_data %>%
  filter(light_environment == 'dark', arena == 'vertical') %>%
  wilcox_test(hunting_success ~ group)

res_hunting_dark_vertical_pooled_wil
# not significant
```